ACT_SPRITE_HEAD  .equ 0
ACT_SPRITE_BODY  .equ 4
ACT_SPRITE_FIRE  .equ 8
ACT_SPRITE_HILT  .equ 12
ACT_SPRITE_BLADE .equ 16
ACT_SPRITE_DIG0  .equ 20
ACT_SPRITE_DIG1  .equ 24
ACT_SPRITE_DIG2  .equ 28

SPRITE_DATA_Y .equ 0
SPRITE_DATA_I .equ 1
SPRITE_DATA_A .equ 2
SPRITE_DATA_X .equ 3

ACT_SPRITE_DATA_LENGTH .equ 32 ; each sprite is 4 bytes
ACT_NUM_FRAMES .equ 7

actor_tick:
  LDX player_room
  LDA dungeon_map, X
  AND #%11110000 ; we only care about the enemies
  CLC
  LSR
  LSR
  LSR
  LSR
  STA enemies_in_room
  
  LDA player_room
  CMP boss_room
  BNE +
    LDA enemies_in_room
    ORA #%00010000
    STA enemies_in_room
  +:
  
  LDA #0
  STA actor_data_pointer
  STA _enemy_loop_counter
  
  ; load in controller player choices
  ; some weird stuff because some buttons are on_down, others are held
  LDA buttons
  AND #$0F ; just the d-pad
  TAX
  LDA button_ondown
  AND #$F0 ; the action buttons
  STA generic_bytes+12
  TXA
  ORA generic_bytes+12
  STA actor_control
  
  
  
  
  JMP +skip_enemy_in_room_check ; player is always in the room
  
  -:
    LDA enemies_in_room
    AND #%00000001
    CMP #0
    BEQ +
      JSR run_ai
      +skip_enemy_in_room_check:
      JSR indv_actor_tick
      JMP ++
    +:
    
      CLC
      ROR enemies_in_room
    ++:
    
    LDA #ACTOR_DATA_LENGTH
    CLC
    ADC actor_data_pointer
    STA actor_data_pointer
  LDA _enemy_loop_counter
  CLC
  ADC #1
  STA _enemy_loop_counter
  CMP NUMBER_OF_ACTORS
  BNE -
  
  
  RTS

run_ai:
  LDA #0
  STA actor_control
  RTS

indv_actor_tick: ; I'm sorry for my inconsistant naming conventions
                 ; (not sorry enough to do something about it though)
  LDA actor_control
  LDX actor_data_pointer
  
  ; walking stuffs
  AND #$0F ; ignore everything but d-pad
  BEQ +no_movement
    AND RIGHT_BUTTON
    BEQ +
      LDA #2
      STA actors+ACT_FACE,X
      
      CLC
      INC actors+ACT_X,X
    +:
    
    LDA actor_control
    AND LEFT_BUTTON
    BEQ +
      LDA #3
      STA actors+ACT_FACE,X
      
      CLC
      DEC actors+ACT_X,X
    +:
    
    LDA actor_control
    AND UP_BUTTON
    BEQ +
      LDA #1
      STA actors+ACT_FACE,X
      
      CLC
      DEC actors+ACT_Y,X
    +:
    
    LDA actor_control
    AND DOWN_BUTTON
    BEQ +
      LDA #0
      STA actors+ACT_FACE,X
      
      CLC
      INC actors+ACT_Y,X
    +:
  
      
    CLC
    INC actors+ACT_ANIM_TIMER,X

  +no_movement:
  
  LDA actor_control ; reload actor_control because we messed with it
  AND START_BUTTON
  BEQ +
    ; pause the game
    LDA #1
    STA paused
    
    ; clear the start button so it doesn't instantly unpause
    LDA START_BUTTON
    EOR #$FF
    AND button_ondown
    STA button_ondown
  +:
  
  ;TEST
  LDX actor_data_pointer
  LDA actors+ACT_X,X
  STA arguments+0
  LDA actors+ACT_Y,X
  STA arguments+1
  JSR get_tile_under_point
  RTS


spawn_actor:
  ;uses generic bytes 16 and 17 to set x and y
  LDX actor_data_pointer
  
  LDA actors+ACT_HPMAX,X
  STA actors+ACT_HP,X
  
  LDA actors+ACT_MANAMAX,X
  STA actors+ACT_MANA,X
  
  LDA generic_bytes+16
  STA actors+ACT_X,X
  
  LDA generic_bytes+17
  STA actors+ACT_Y,X
  
  LDA #$ff
  STA actors+ACT_FIRE_Y,X
  
  
  LDA #0
  STA actors+ACT_ATTKTIME,X
  STA actors+ACT_ANIM_TIMER,X
  STA actors+ACT_FACE,X
  STA actors+ACT_FIRE_FACE,X
  STA actors+ACT_FIRE_X,X
  STA actors+ACT_FIRE_XVEL,X
  STA actors+ACT_FIRE_YVEL,X
  STA actors+ACT_FIRE_ANIM_TIMER,X
  STA actors+ACT_READOUT_TIMER,X
  STA actors+ACT_READOUT_VALUE,X
  
  RTS
  

  .incsrc "src/play/draw_actors.6502"
